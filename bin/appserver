#!/usr/bin/env ruby

$:.unshift File.dirname(__FILE__) + "/../lib"

require 'optparse'
require 'appserver'

options = {}
opts = OptionParser.new(nil, 20, '  ') do |opts|
  opts.banner = 'Usage: appserver [options] init|deploy|update [arguments]'
  opts.separator ''
  opts.separator 'appserver [options] init'
  opts.separator '  Initializes an appserver directory. Run this command once in an empty'
  opts.separator '  directory to set it up for deploying applications. After this, you can'
  opts.separator '  customize settings in appserver.yml inside this directory.'
  opts.separator ''
  opts.separator 'appserver [options] deploy <git-repository>'
  opts.separator '  Deploys an application to the appserver directory and updates configurations.'
  opts.separator '  Additionally, a hook is installed to the git repository, that auto-deploys'
  opts.separator '  the application from now on, if sombody pushes to it.'
  opts.separator ''
  opts.separator 'appserver [options] update'
  opts.separator '  Updates all generated configuration files.'
  opts.separator ''
  opts.separator 'Options:'
  opts.on '-d', '--dir PATH', 'Specifies the server directory to use instead of the', 'current working directory' do |dir|
    options[:dir] = dir
  end
  opts.separator ''
  opts.separator 'Common options:'
  opts.on '-h', '--help', 'Show this message' do
    puts opts; exit
  end
  opts.separator ''
  opts.separator 'See http://github.com/zargony/appserver for more information'
  opts.separator ''
end

args = opts.parse!

(puts opts; exit) if args.size < 1
Appserver::Command.run!(args.shift, args, options)
